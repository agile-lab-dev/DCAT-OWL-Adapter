# Python Specific Provisioner

This REST application mocks a specific provisioner for data product components.

This project uses OpenAPI as standard API specification and the [fastapi-code-generator](https://pypi.org/project/fastapi-code-generator/)

#### Setup Python environment
To set up a Python environment we use [Poetry](https://python-poetry.org/docs/):

```
curl -sSL https://install.python-poetry.org | python3 -
```
Once Poetry is installed and in your `$PATH`, you can execute the following:
```
poetry --version
```
If you see something like `Poetry (version x.x.x)`, your install is ready to use!

Install the dependencies defined in `specific-provisioner/pyproject.toml`:
```
cd specific-provisioner
poetry install
```

#### Generate FastAPI server starting from OpenAPI specification
Activate the Python virtual environment generated by Poetry:
```
source $(poetry env info --path)/bin/activate
```
Start the script `generate_api_setup.py`:
```
cd ..
python generate_api_setup.py
```
For default settings, Python scripts `specific-provisioner/src/main.py` and `specific-provisioner/src/models.py` will be generated by exploiting the specification file `specific-provisioner/interface-specification.yml`.

The script `generate_api_setup.py` also installs the [pre-commit](https://pre-commit.com/) framework to automatically handle the linter, formatter, and static type checker.

#### Remarks
The autogenerated code from `fastapi-code-generator` contains `pass` within the various functions. In order for `mypy` not to report errors, it is necessary to properly modify the return type of the output according to the specified types by the functions.

Note that Gitlab's CI pipeline expects to find unit tests in the `tests/` folder otherwise the whole process will be blocked.

#### Additional references
- To configure the `OpenTelemetry framework` refer to the [OpenTelemetry Setup](./specific-provisioner/docs/opentelemetry.md).
- To build an `image` and run the `docker container` refer to [Docker Setup](./specific-provisioner/docs/docker.md).

#### FAQs
Sometimes, you might face a problem where you will face issue while trying to generate code from `fastapi-code-generator`. The error will look like the below one -

```
sh: fastapi-codegen: command not found
Generating the API code structure.........
______________________________________________________________________________

¬†

Installing 'pre-commit'.......
sh: pre-commit: command not found
______________________________________________________________________________

¬†

Adding 'noqa' for autogenerated code......
sh: ruff: command not found
______________________________________________________________________________

¬†

Black formatting......
All done! ‚ú® üç∞ ‚ú®
1 file left unchanged.
______________________________________________________________________________

¬†

¬†

SETUP COMPLETED!
```

In this case, it would seem to us that the file ran successfully but in reality you will not be able to see the files generated under `specific-provisioner/src` folder.

This might happen on macOS machines in which the python installation happened through the [package installer](https://www.python.org/downloads/macos/) which lacks the necessary developer tools which in turn will not be able to recognize the packages installed via `poetry`.

In order to avoid this scenario, do the following -
- Install the version of python compatible with the project (in this case, the required python version is `3.11`) with the help of `brew` using the below command -

    ```brew install python@3.11```

- If you already have the required python version, run the below `brew` command -

    ```brew reinstall python@3.11```

- Uninstall and re-install the `Poetry` using the below commands -

    ```curl -sSL https://install.python-poetry.org | python3 - --uninstall```

    ```curl -sSL https://install.python-poetry.org | python3 -```

- Finally, follow the above steps for re-initializing the project and try to generate `models` from api-specification file.

#### Resources

- [Python poetry install fails on typed-ast (1.5.4). How to overcome the obstacle and install the package?](https://stackoverflow.com/questions/75824594/python-poetry-install-fails-on-typed-ast-1-5-4-how-to-overcome-the-obstacle-a)
- [how to install python-devel in macOS?](https://stackoverflow.com/questions/32578106/how-to-install-python-devel-in-mac-os)
- [Homebrew Formulae](https://formulae.brew.sh/formula/python@3.11)
